<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>elvec1o CMS</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6; background: #fafafa; }

    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }

    header { background: #111; color: #fff; padding: 1rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    header h1 { font-size: 1.2rem; text-transform: uppercase; letter-spacing: 0.1em; flex: 1; }
    .live-site-btn { background: #2e7d32; color: #fff; padding: 0.6rem 1.2rem; text-decoration: none; font-weight: bold; font-size: 0.95rem; border-radius: 4px; display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s; }
    .live-site-btn:hover { background: #1b5e20; }

    .git-status { font-size: 0.85rem; display: flex; gap: 1rem; align-items: center; }
    .git-status .indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .git-status .indicator.clean { background: #4CAF50; }
    .git-status .indicator.dirty { background: #ff9800; }

    .tabs { display: flex; gap: 0; border-bottom: 2px solid #111; margin-bottom: 1rem; }
    .tab { background: #fff; color: #111; border: 1px solid #ddd; border-bottom: none; padding: 0.75rem 1.5rem; cursor: pointer; font-family: inherit; margin-bottom: -2px; }
    .tab:hover { background: #f5f5f5; color: #111; }
    .tab.active { background: #111; color: #fff; border-color: #111; }

    .panel { display: none; background: #fff; padding: 1.5rem; border: 1px solid #ddd; }
    .panel.active { display: block; }

    .toolbar { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }

    button { background: #111; color: #fff; border: none; padding: 0.5rem 1rem; cursor: pointer; font-family: inherit; font-size: 0.9rem; }
    button:hover { background: #333; }
    button.secondary { background: #fff; color: #111; border: 1px solid #ddd; }
    button.secondary:hover { background: #f5f5f5; }
    button.danger { background: #c00; }
    button.danger:hover { background: #a00; }
    button.success { background: #2e7d32; }
    button.success:hover { background: #1b5e20; }

    .entry-list { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; }
    .entry-item { padding: 0.75rem 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .entry-item:hover { background: #f9f9f9; }
    .entry-item.selected { background: #e3f2fd; }
    .entry-item-info { flex: 1; }
    .entry-item-title { font-weight: bold; }
    .entry-item-meta { font-size: 0.8rem; color: #666; }
    .entry-item-type { font-size: 0.7rem; background: #f0f0f0; padding: 0.15rem 0.4rem; margin-left: 0.5rem; }

    .editor { margin-top: 1rem; }
    .editor h3 { margin-bottom: 1rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem; }

    .form-row { margin-bottom: 1rem; }
    .form-row label { display: block; margin-bottom: 0.3rem; font-weight: bold; }
    .form-row input, .form-row textarea, .form-row select { width: 100%; padding: 0.5rem; border: 1px solid #ddd; font-family: inherit; font-size: inherit; }
    .form-row textarea { min-height: 100px; resize: vertical; }
    .form-row .help { font-size: 0.8rem; color: #666; margin-top: 0.2rem; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

    .toast { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; background: #111; color: #fff; border-radius: 4px; display: none; z-index: 1000; }
    .toast.success { background: #2e7d32; }
    .toast.error { background: #c62828; }
    .toast.show { display: block; animation: slideIn 0.3s ease; }

    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: #fff; padding: 2rem; max-width: 500px; width: 90%; }
    .modal-content h3 { margin-bottom: 1rem; }
    .modal-actions { margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end; }

    /* Debug Panel */
    .debug-panel { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; color: #0f0; font-family: 'Courier New', monospace; font-size: 12px; z-index: 1001; }
    .debug-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; background: #000; border-top: 2px solid #333; }
    .debug-header span { font-weight: bold; }
    .debug-controls { display: flex; gap: 0.5rem; }
    .debug-controls button { background: #333; color: #fff; border: none; padding: 0.3rem 0.6rem; font-size: 11px; cursor: pointer; }
    .debug-controls button:hover { background: #555; }
    .debug-log { max-height: 150px; overflow-y: auto; padding: 0.5rem 1rem; display: none; }
    .debug-panel.expanded .debug-log { display: block; }
    .debug-entry { padding: 0.2rem 0; border-bottom: 1px solid #333; }
    .debug-entry.error { color: #f55; }
    .debug-entry.success { color: #5f5; }
    .debug-entry.info { color: #5af; }
    .debug-time { color: #888; margin-right: 0.5rem; }
    body { padding-bottom: 40px; }
    .debug-panel.expanded ~ body, body:has(.debug-panel.expanded) { padding-bottom: 200px; }

    /* Error Modal */
    .error-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; }
    .error-modal.active { display: flex; }
    .error-modal-content { background: #1a1a1a; color: #fff; padding: 1.5rem; max-width: 600px; width: 90%; border: 2px solid #f55; border-radius: 8px; }
    .error-modal-content h3 { color: #f55; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .error-modal-content .error-message { background: #111; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; font-size: 13px; }
    .error-modal-content .fix-section { background: #0a2a0a; border: 1px solid #2e7d32; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
    .error-modal-content .fix-section h4 { color: #5f5; margin-bottom: 0.5rem; }
    .error-modal-content .fix-command { background: #000; padding: 0.75rem; font-family: 'Courier New', monospace; font-size: 13px; color: #0f0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .error-modal-content .fix-command code { flex: 1; word-break: break-all; }
    .error-modal-content .fix-command button { background: #333; color: #fff; border: none; padding: 0.4rem 0.8rem; cursor: pointer; white-space: nowrap; }
    .error-modal-content .fix-command button:hover { background: #555; }
    .error-modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; }
    .error-modal-actions button { padding: 0.5rem 1rem; }

    /* Activity Log */
    .activity-log { border: 1px solid #ddd; max-height: 500px; overflow-y: auto; }
    .activity-item { padding: 0.75rem 1rem; border-bottom: 1px solid #eee; display: flex; gap: 1rem; align-items: flex-start; }
    .activity-item:last-child { border-bottom: none; }
    .activity-icon { font-size: 1.2rem; width: 30px; text-align: center; }
    .activity-content { flex: 1; }
    .activity-title { font-weight: bold; margin-bottom: 0.2rem; }
    .activity-detail { font-size: 0.85rem; color: #666; }
    .activity-time { font-size: 0.75rem; color: #999; white-space: nowrap; }
    .activity-item.success { background: #f0fff0; border-left: 3px solid #2e7d32; }
    .activity-item.error { background: #fff0f0; border-left: 3px solid #c00; }
    .activity-item.info { background: #f0f8ff; border-left: 3px solid #1976d2; }
    .activity-item.warning { background: #fffaf0; border-left: 3px solid #ff9800; }
    .activity-empty { padding: 2rem; text-align: center; color: #999; }

    /* File list */
    .file-item { padding: 0.5rem 1rem; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
    .file-item:hover { background: #f5f5f5; }
    .file-item.selected { background: #e3f2fd; }
    .file-item .file-icon { font-size: 1.3rem; }
    .file-item .file-name { flex: 1; }
    .file-item .file-size { color: #888; font-size: 0.85rem; }
    .file-item.folder .file-name { font-weight: bold; }

    /* Upload dropzone */
    .dropzone { border: 2px dashed #ccc; padding: 2rem; text-align: center; margin-bottom: 1rem; border-radius: 4px; }
    .dropzone.dragover { border-color: #2e7d32; background: #f0fff0; }
  </style>
</head>
<body>
  <header>
    <a href="https://elvec1o.github.io/home/" target="_blank" class="live-site-btn">üåê View Live Site</a>
    <h1>elvec1o CMS</h1>
    <div class="git-status">
      <span class="indicator" id="gitIndicator"></span>
      <span id="gitStatusText">Checking...</span>
      <button class="success" onclick="pushChanges()">Push to GitHub</button>
    </div>
  </header>

  <div class="container">
    <div class="tabs">
      <button class="tab active" data-tab="breaks">Breaks</button>
      <button class="tab" data-tab="writeups">Writeups</button>
      <button class="tab" data-tab="import">üì• Import</button>
      <button class="tab" data-tab="books">Books</button>
      <button class="tab" data-tab="files">Files</button>
      <button class="tab" data-tab="uploads">üìÅ Uploads</button>
      <button class="tab" data-tab="config">Config</button>
      <button class="tab" data-tab="activity">üìã Activity</button>
      <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
    </div>

    <!-- WRITEUPS PANEL -->
    <div class="panel" id="panel-writeups">
      <div class="toolbar">
        <button onclick="addEntry('writeups')">+ New Writeup</button>
        <button class="secondary" onclick="saveData('writeups')">Save</button>
        <button class="secondary" onclick="saveData('writeups', true)">Save & Push</button>
      </div>
      <div class="entry-list" id="list-writeups"></div>
      <div class="editor" id="editor-writeups" style="display:none;">
        <h3>Edit Writeup</h3>
        <div class="form-grid">
          <div class="form-row">
            <label>ID (slug)</label>
            <input type="text" id="writeups-id" placeholder="unique-slug">
          </div>
          <div class="form-row">
            <label>Priority (1-9)</label>
            <input type="number" id="writeups-priority" min="1" max="9" value="5">
          </div>
        </div>
        <div class="form-grid">
          <div class="form-row">
            <label>Target</label>
            <input type="text" id="writeups-target" placeholder="e.g. Claude, Qwen3-Max">
          </div>
          <div class="form-row">
            <label>Title</label>
            <input type="text" id="writeups-title" placeholder="Writeup title">
          </div>
        </div>
        <div class="form-grid">
          <div class="form-row">
            <label>Technique</label>
            <input type="text" id="writeups-technique" placeholder="e.g. Framing, Persistence">
          </div>
          <div class="form-row">
            <label>Date</label>
            <input type="date" id="writeups-date">
          </div>
        </div>
        <div class="form-row">
          <label>Publication Value</label>
          <select id="writeups-pubValue">
            <option value="üî•üî•üî•üî•üî• CRITICAL">üî•üî•üî•üî•üî• CRITICAL</option>
            <option value="üî•üî•üî•üî• HIGH">üî•üî•üî•üî• HIGH</option>
            <option value="üî•üî•üî• MEDIUM">üî•üî•üî• MEDIUM</option>
            <option value="üî•üî• LOW">üî•üî• LOW</option>
          </select>
        </div>
        <div class="form-row">
          <label>TL;DR</label>
          <textarea id="writeups-tldr" placeholder="One-sentence summary" style="min-height:60px;"></textarea>
        </div>
        <div class="form-row">
          <label>Content (Markdown)</label>
          <textarea id="writeups-content" placeholder="Full writeup content in Markdown..." style="min-height:300px;"></textarea>
        </div>
        <div class="form-row">
          <label>Images (comma-separated paths)</label>
          <input type="text" id="writeups-images" placeholder="/img/writeups/screenshot1.png, /img/writeups/screenshot2.png">
          <p style="font-size:0.8rem;color:#888;margin-top:0.3rem;">Upload images in the Uploads tab first, then paste paths here</p>
        </div>
        <div style="margin-top:1rem;">
          <button onclick="updateEntry('writeups')">Save Entry</button>
          <button class="danger" onclick="deleteEntry('writeups')">Delete</button>
          <button class="secondary" onclick="cancelEdit('writeups')">Cancel</button>
        </div>
      </div>
    </div>

    <!-- IMPORT PANEL -->
    <div class="panel" id="panel-import">
      <div style="background:#e8f5e9;padding:1rem;border-radius:8px;margin-bottom:1.5rem;border:1px solid #4caf50;">
        <h3 style="margin-bottom:0.5rem;color:#2e7d32;">üì• Bulk Import</h3>
        <p style="font-size:0.9rem;color:#555;">Paste XML content below to automatically parse and import multiple items at once. The parser will detect writeups, breaks, or any structured content.</p>
      </div>

      <div class="form-row">
        <label>Import Type</label>
        <select id="import-type" style="width:200px;">
          <option value="writeups">Writeups</option>
          <option value="breaks">Breaks</option>
          <option value="auto">Auto-detect</option>
        </select>
      </div>

      <div class="form-row">
        <label>Paste XML Content</label>
        <textarea id="import-xml" placeholder="<articles>
  <article>
    <title>My Article Title</title>
    <target>Claude</target>
    <technique>Prompt Injection</technique>
    <content>Full article content here...</content>
  </article>
  ...
</articles>" style="min-height:400px;font-family:'Courier New',monospace;font-size:12px;"></textarea>
      </div>

      <div class="toolbar">
        <button onclick="parseImport()">üîç Parse & Preview</button>
        <button class="secondary" onclick="clearImport()">üóëÔ∏è Clear</button>
        <button class="secondary" onclick="loadSampleXML()">üìÑ Load Sample</button>
      </div>

      <div id="import-preview" style="display:none;margin-top:1.5rem;">
        <h3 style="margin-bottom:1rem;border-bottom:2px solid #111;padding-bottom:0.5rem;">
          üìã Preview (<span id="import-count">0</span> items detected)
        </h3>
        <div id="import-items" style="max-height:300px;overflow-y:auto;border:1px solid #ddd;"></div>
        <div style="margin-top:1rem;padding:1rem;background:#fff3e0;border-radius:4px;">
          <label><input type="checkbox" id="import-replace"> Replace existing data (unchecked = append)</label>
        </div>
        <div style="margin-top:1rem;">
          <button class="success" onclick="executeImport()">‚úÖ Import All</button>
          <button class="success" onclick="executeImport(true)">‚úÖ Import & Push</button>
        </div>
      </div>

      <div id="import-result" style="display:none;margin-top:1.5rem;padding:1rem;border-radius:8px;"></div>
    </div>

    <!-- BREAKS PANEL -->
    <div class="panel active" id="panel-breaks">
      <div class="toolbar">
        <button onclick="addEntry('breaks')">+ New Break</button>
        <button class="secondary" onclick="saveData('breaks')">Save</button>
        <button class="secondary" onclick="saveData('breaks', true)">Save & Push</button>
      </div>
      <div class="entry-list" id="list-breaks"></div>
      <div class="editor" id="editor-breaks" style="display:none;">
        <h3>Edit Break</h3>
        <div class="form-grid">
          <div class="form-row">
            <label>ID</label>
            <input type="text" id="breaks-id" placeholder="unique-id-slug">
          </div>
          <div class="form-row">
            <label>Type</label>
            <select id="breaks-type">
              <option value="">Break (default)</option>
              <option value="xpost">X Post</option>
              <option value="featured">Featured</option>
            </select>
          </div>
        </div>
        <div class="form-row" id="breaks-xpost-fields" style="display:none;">
          <label>Tweet URL</label>
          <input type="text" id="breaks-tweetUrl" placeholder="https://twitter.com/...">
          <div class="form-row">
            <label>Note</label>
            <input type="text" id="breaks-note" placeholder="Brief note about this post">
          </div>
        </div>
        <div id="breaks-standard-fields">
          <div class="form-grid">
            <div class="form-row">
              <label>Name</label>
              <input type="text" id="breaks-name" placeholder="Attack Name">
            </div>
            <div class="form-row">
              <label>Technique</label>
              <input type="text" id="breaks-technique" placeholder="e.g. Visual Prompt Injection">
            </div>
          </div>
          <div class="form-grid">
            <div class="form-row">
              <label>Category</label>
              <input type="text" id="breaks-category" placeholder="e.g. üñºÔ∏è Visual">
            </div>
            <div class="form-row">
              <label>Date</label>
              <input type="date" id="breaks-date">
            </div>
          </div>
          <div class="form-row">
            <label>Challenge</label>
            <input type="text" id="breaks-challenge" placeholder="What was the goal?">
          </div>
          <div class="form-row">
            <label>Insight</label>
            <textarea id="breaks-insight" placeholder="Why did this work?"></textarea>
          </div>
          <div class="form-row">
            <label>Prompt</label>
            <textarea id="breaks-prompt" placeholder="The prompt used"></textarea>
          </div>
          <div class="form-row">
            <label>Result</label>
            <textarea id="breaks-result" placeholder="What happened"></textarea>
          </div>
          <div class="form-row">
            <label>URL</label>
            <input type="text" id="breaks-url" placeholder="https://app.grayswan.ai/...">
          </div>
        </div>
        <div style="margin-top:1rem;">
          <button onclick="updateEntry('breaks')">Save Entry</button>
          <button class="danger" onclick="deleteEntry('breaks')">Delete</button>
          <button class="secondary" onclick="cancelEdit('breaks')">Cancel</button>
        </div>
      </div>
    </div>

    <!-- BOOKS PANEL -->
    <div class="panel" id="panel-books">
      <div class="toolbar">
        <button onclick="addEntry('books')">+ New Book</button>
        <button class="secondary" onclick="saveData('books')">Save</button>
        <button class="secondary" onclick="saveData('books', true)">Save & Push</button>
      </div>
      <div class="entry-list" id="list-books"></div>
      <div class="editor" id="editor-books" style="display:none;">
        <h3>Edit Book</h3>
        <div class="form-grid">
          <div class="form-row">
            <label>ID</label>
            <input type="text" id="books-id" placeholder="unique-id">
          </div>
          <div class="form-row">
            <label>Title</label>
            <input type="text" id="books-title" placeholder="Book Title">
          </div>
        </div>
        <div class="form-grid">
          <div class="form-row">
            <label>Author</label>
            <input type="text" id="books-author" placeholder="Author name">
          </div>
          <div class="form-row">
            <label>Date</label>
            <input type="date" id="books-date">
          </div>
        </div>
        <div class="form-row">
          <label>Description</label>
          <textarea id="books-description" placeholder="Brief description"></textarea>
        </div>
        <div class="form-grid">
          <div class="form-row">
            <label>Filename</label>
            <input type="text" id="books-filename" placeholder="file.docx">
          </div>
          <div class="form-row">
            <label>Size</label>
            <input type="text" id="books-size" placeholder="e.g. 30 KB">
          </div>
        </div>
        <div style="margin-top:1rem;">
          <button onclick="updateEntry('books')">Save Entry</button>
          <button class="danger" onclick="deleteEntry('books')">Delete</button>
          <button class="secondary" onclick="cancelEdit('books')">Cancel</button>
        </div>
      </div>
    </div>

    <!-- FILES PANEL -->
    <div class="panel" id="panel-files">
      <div class="toolbar">
        <button onclick="addEntry('files')">+ New File</button>
        <button class="secondary" onclick="saveData('files')">Save</button>
        <button class="secondary" onclick="saveData('files', true)">Save & Push</button>
      </div>
      <div class="entry-list" id="list-files"></div>
      <div class="editor" id="editor-files" style="display:none;">
        <h3>Edit File</h3>
        <div class="form-grid">
          <div class="form-row">
            <label>ID</label>
            <input type="text" id="files-id" placeholder="unique-id">
          </div>
          <div class="form-row">
            <label>Name</label>
            <input type="text" id="files-name" placeholder="Display name">
          </div>
        </div>
        <div class="form-grid">
          <div class="form-row">
            <label>Type</label>
            <input type="text" id="files-type" placeholder="e.g. app, experiment">
          </div>
          <div class="form-row">
            <label>Date</label>
            <input type="date" id="files-date">
          </div>
        </div>
        <div class="form-row">
          <label>Description</label>
          <textarea id="files-description" placeholder="Brief description"></textarea>
        </div>
        <div class="form-grid">
          <div class="form-row">
            <label>Filename</label>
            <input type="text" id="files-filename" placeholder="folder/ or file.zip">
          </div>
          <div class="form-row">
            <label>Size</label>
            <input type="text" id="files-size" placeholder="e.g. ~1 MB">
          </div>
        </div>
        <div class="form-row">
          <label><input type="checkbox" id="files-isFolder"> Is Folder</label>
        </div>
        <div style="margin-top:1rem;">
          <button onclick="updateEntry('files')">Save Entry</button>
          <button class="danger" onclick="deleteEntry('files')">Delete</button>
          <button class="secondary" onclick="cancelEdit('files')">Cancel</button>
        </div>
      </div>
    </div>

    <!-- UPLOADS PANEL -->
    <div class="panel" id="panel-uploads">
      <div class="toolbar">
        <button onclick="document.getElementById('fileInput').click()">üì§ Upload Files</button>
        <button class="secondary" onclick="createFolder()">üìÅ New Folder</button>
        <button class="secondary" onclick="loadFilesList()">üîÑ Refresh</button>
        <button class="success" onclick="pushUploads()">üöÄ Push Uploads</button>
        <input type="file" id="fileInput" multiple style="display:none;" onchange="uploadFiles(this.files)">
      </div>

      <div style="margin-bottom:1rem;">
        <label style="font-weight:bold;">Current folder: </label>
        <span id="currentFolder">/img</span>
        <button class="secondary" style="margin-left:0.5rem;padding:0.2rem 0.5rem;font-size:0.8rem;" onclick="navigateUp()">‚¨ÜÔ∏è Up</button>
      </div>

      <div style="background:#f5f5f5;padding:1rem;border-radius:4px;margin-bottom:1rem;">
        <label style="font-weight:bold;">Quick upload to folder:</label>
        <select id="uploadFolder" style="margin-left:0.5rem;padding:0.3rem;">
          <option value="img">img (default)</option>
          <option value="img/writeups">img/writeups</option>
          <option value="img/breaks">img/breaks</option>
        </select>
      </div>

      <div class="entry-list" id="filesList" style="min-height:200px;">
        <div class="activity-empty">Loading files...</div>
      </div>

      <div id="filePreview" style="display:none;margin-top:1rem;padding:1rem;background:#f9f9f9;border:1px solid #ddd;border-radius:4px;">
        <h4 style="margin-bottom:0.5rem;">Selected file:</h4>
        <div id="previewContent"></div>
        <div style="margin-top:0.5rem;">
          <button class="secondary" onclick="copyFilePath()">üìã Copy Path</button>
          <button class="danger" onclick="deleteSelectedFile()">üóëÔ∏è Delete</button>
        </div>
      </div>
    </div>

    <!-- CONFIG PANEL -->
    <div class="panel" id="panel-config">
      <div class="toolbar">
        <button class="secondary" onclick="saveData('config')">Save</button>
        <button class="secondary" onclick="saveData('config', true)">Save & Push</button>
      </div>
      <div class="editor" style="display:block;">
        <h3>Site Configuration</h3>
        <div class="form-row">
          <label>Title</label>
          <input type="text" id="config-title" placeholder="Site title">
        </div>
        <div class="form-row">
          <label>Tagline</label>
          <textarea id="config-tagline" placeholder="Your tagline"></textarea>
        </div>
        <div class="form-row">
          <label>About (Paragraph 1)</label>
          <textarea id="config-about1" placeholder="First about paragraph"></textarea>
        </div>
        <div class="form-row">
          <label>About (Paragraph 2)</label>
          <textarea id="config-about2" placeholder="Second about paragraph"></textarea>
        </div>
        <div class="form-grid">
          <div class="form-row">
            <label>X Handle</label>
            <input type="text" id="config-xHandle" placeholder="username (no @)">
          </div>
          <div class="form-row">
            <label>Gray Swan Username</label>
            <input type="text" id="config-grayswanUser" placeholder="username">
          </div>
        </div>
      </div>
    </div>

    <!-- SETTINGS PANEL -->
    <div class="panel" id="panel-settings">
      <div class="editor" style="display:block;">
        <h3>üîê GitHub Authentication</h3>
        <p style="margin-bottom:1rem;color:#666;">Configure SSH or token authentication to push to GitHub.</p>

        <div style="background:#f5f5f5;padding:1rem;border-radius:4px;margin-bottom:1.5rem;">
          <h4 style="margin-bottom:0.5rem;">Current Remote</h4>
          <code id="currentRemote" style="background:#fff;padding:0.5rem;display:block;border:1px solid #ddd;">Loading...</code>
        </div>

        <div style="background:#e3f2fd;padding:1rem;border-radius:4px;margin-bottom:1.5rem;">
          <h4 style="margin-bottom:0.5rem;">Option 1: SSH Key (Recommended)</h4>
          <p style="font-size:0.9rem;color:#666;margin-bottom:1rem;">Generate an SSH key and add it to your GitHub account.</p>

          <div style="margin-bottom:1rem;">
            <button onclick="generateSSHKey()">üîë Generate SSH Key</button>
            <button class="secondary" onclick="checkSSHKey()">üîç Check Existing Key</button>
          </div>

          <div id="sshKeyDisplay" style="display:none;margin-top:1rem;">
            <label style="font-weight:bold;">Your Public Key (copy this to GitHub):</label>
            <textarea id="sshPublicKey" readonly style="width:100%;height:80px;font-family:monospace;font-size:11px;margin-top:0.5rem;"></textarea>
            <div style="margin-top:0.5rem;">
              <button class="secondary" onclick="copySSHKey()">üìã Copy Key</button>
              <a href="https://github.com/settings/ssh/new" target="_blank" style="margin-left:1rem;">
                <button type="button">üîó Add to GitHub</button>
              </a>
            </div>
          </div>

          <div style="margin-top:1rem;">
            <button class="secondary" onclick="testSSHConnection()">üß™ Test SSH Connection</button>
            <button class="success" onclick="switchToSSH()">‚úÖ Use SSH Remote</button>
          </div>
        </div>

        <div style="background:#fff3e0;padding:1rem;border-radius:4px;">
          <h4 style="margin-bottom:0.5rem;">Option 2: GitHub Token</h4>
          <p style="font-size:0.9rem;color:#666;margin-bottom:1rem;">Use a Personal Access Token for HTTPS authentication.</p>

          <div class="form-row">
            <label>GitHub Token</label>
            <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">
            <p style="font-size:0.8rem;color:#888;margin-top:0.3rem;">
              <a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank">Generate a token</a> with 'repo' scope
            </p>
          </div>
          <button onclick="saveGitHubToken()">üíæ Save Token & Configure</button>
        </div>
      </div>
    </div>

    <!-- ACTIVITY PANEL -->
    <div class="panel" id="panel-activity">
      <div class="toolbar">
        <button class="secondary" onclick="clearActivity()">üóëÔ∏è Clear History</button>
        <button class="secondary" onclick="copyActivity()">üìã Copy All</button>
      </div>
      <div class="activity-log" id="activityLog">
        <div class="activity-empty">No activity yet. Start editing to see your history here.</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Debug Panel -->
  <div class="debug-panel" id="debugPanel">
    <div class="debug-header">
      <span>üêõ Debug Log (<span id="debugCount">0</span>)</span>
      <div class="debug-controls">
        <button onclick="copyDebugLog()">üìã Copy All</button>
        <button onclick="clearDebugLog()">üóëÔ∏è Clear</button>
        <button onclick="toggleDebugPanel()">‚ñ≤ Expand</button>
      </div>
    </div>
    <div class="debug-log" id="debugLog"></div>
  </div>

  <!-- Error Modal with Fix -->
  <div class="error-modal" id="errorModal">
    <div class="error-modal-content">
      <h3>‚ö†Ô∏è <span id="errorTitle">Error</span></h3>
      <div class="error-message" id="errorMessage"></div>
      <div class="fix-section" id="fixSection" style="display:none;">
        <h4>üîß Quick Fix</h4>
        <p id="fixDescription" style="margin-bottom:0.5rem;font-size:13px;color:#aaa;"></p>
        <div class="fix-command">
          <code id="fixCommand"></code>
          <button onclick="copyFixCommand()">üìã Copy</button>
        </div>
      </div>
      <div class="error-modal-actions">
        <button class="secondary" onclick="closeErrorModal()">Close</button>
        <button onclick="runFixCommand()" id="runFixBtn" style="display:none;">‚ö° Run Fix</button>
        <button class="success" onclick="retryLastAction()" id="retryBtn" style="display:none;">üîÑ Retry</button>
      </div>
    </div>
  </div>

  <div class="modal" id="pushModal">
    <div class="modal-content">
      <h3>Push to GitHub</h3>
      <div class="form-row">
        <label>Commit message</label>
        <input type="text" id="commitMessage" value="Update via CMS">
      </div>
      <div class="modal-actions">
        <button class="secondary" onclick="closePushModal()">Cancel</button>
        <button class="success" onclick="confirmPush()">Push</button>
      </div>
    </div>
  </div>

<script>
const API = '';
let data = { breaks: [], books: [], files: [], config: {}, writeups: [] };
let selectedIndex = { breaks: -1, books: -1, files: -1, writeups: -1 };

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
  });
});

// Breaks type toggle
document.getElementById('breaks-type').addEventListener('change', (e) => {
  const isXpost = e.target.value === 'xpost';
  document.getElementById('breaks-xpost-fields').style.display = isXpost ? 'block' : 'none';
  document.getElementById('breaks-standard-fields').style.display = isXpost ? 'none' : 'block';
});

// Load all data
async function loadAll() {
  try {
    const [breaks, books, files, config, writeups] = await Promise.all([
      fetch(API + '/api/breaks').then(r => r.json()),
      fetch(API + '/api/books').then(r => r.json()),
      fetch(API + '/api/files').then(r => r.json()),
      fetch(API + '/api/config').then(r => r.json()),
      fetch(API + '/api/writeups').then(r => r.json()).catch(() => [])
    ]);
    data = { breaks, books, files, config, writeups: writeups || [] };
    renderList('breaks');
    renderList('books');
    renderList('files');
    renderList('writeups');
    renderConfig();
    checkGitStatus();
  } catch (err) {
    showToast('Failed to load data: ' + err.message, 'error');
  }
}

// Check git status
async function checkGitStatus() {
  try {
    const status = await fetch(API + '/api/git-status').then(r => r.json());
    const indicator = document.getElementById('gitIndicator');
    const text = document.getElementById('gitStatusText');
    if (status.clean) {
      indicator.className = 'indicator clean';
      text.textContent = 'Clean';
    } else {
      indicator.className = 'indicator dirty';
      const changes = [...status.modified, ...status.created].length;
      text.textContent = `${changes} changed`;
    }
  } catch (err) {
    document.getElementById('gitStatusText').textContent = 'Error';
  }
}

// Render list
function renderList(type) {
  const list = document.getElementById('list-' + type);
  if (!list) return;
  const items = data[type] || [];

  list.innerHTML = items.map((item, i) => {
    let title, meta;
    if (type === 'breaks') {
      title = item.type === 'xpost' ? (item.note || 'X Post') : item.name;
      meta = item.type === 'xpost' ? item.date : `${item.technique} ¬∑ ${item.date}`;
    } else if (type === 'books') {
      title = item.title;
      meta = `${item.author} ¬∑ ${item.size}`;
    } else if (type === 'writeups') {
      title = item.title;
      meta = `${item.target} ¬∑ ${item.pubValue || ''} ¬∑ ${item.date}`;
    } else {
      title = item.name;
      meta = `${item.type} ¬∑ ${item.size}`;
    }
    const typeLabel = type === 'breaks' && item.type ? `<span class="entry-item-type">${item.type}</span>` : '';
    const priorityLabel = type === 'writeups' && item.priority ? `<span class="entry-item-type">#${item.priority}</span>` : '';
    return `
      <div class="entry-item ${selectedIndex[type] === i ? 'selected' : ''}" onclick="selectEntry('${type}', ${i})">
        <div class="entry-item-info">
          <div class="entry-item-title">${title}${typeLabel}${priorityLabel}</div>
          <div class="entry-item-meta">${meta}</div>
        </div>
      </div>
    `;
  }).join('');
}

// Render config
function renderConfig() {
  const c = data.config;
  document.getElementById('config-title').value = c.title || '';
  document.getElementById('config-tagline').value = c.tagline || '';
  document.getElementById('config-about1').value = c.about1 || '';
  document.getElementById('config-about2').value = c.about2 || '';
  document.getElementById('config-xHandle').value = c.xHandle || '';
  document.getElementById('config-grayswanUser').value = c.grayswanUser || '';
}

// Select entry
function selectEntry(type, index) {
  selectedIndex[type] = index;
  renderList(type);
  showEditor(type, data[type][index]);
}

// Show editor
function showEditor(type, item) {
  document.getElementById('editor-' + type).style.display = 'block';

  if (type === 'breaks') {
    document.getElementById('breaks-id').value = item.id || '';
    document.getElementById('breaks-type').value = item.type || '';
    document.getElementById('breaks-type').dispatchEvent(new Event('change'));

    if (item.type === 'xpost') {
      document.getElementById('breaks-tweetUrl').value = item.tweetUrl || '';
      document.getElementById('breaks-note').value = item.note || '';
      document.getElementById('breaks-date').value = item.date || '';
    } else {
      document.getElementById('breaks-name').value = item.name || '';
      document.getElementById('breaks-technique').value = item.technique || '';
      document.getElementById('breaks-category').value = item.category || '';
      document.getElementById('breaks-date').value = item.date || '';
      document.getElementById('breaks-challenge').value = item.challenge || '';
      document.getElementById('breaks-insight').value = item.insight || '';
      document.getElementById('breaks-prompt').value = item.prompt || '';
      document.getElementById('breaks-result').value = item.result || '';
      document.getElementById('breaks-url').value = item.url || '';
    }
  } else if (type === 'books') {
    document.getElementById('books-id').value = item.id || '';
    document.getElementById('books-title').value = item.title || '';
    document.getElementById('books-author').value = item.author || '';
    document.getElementById('books-description').value = item.description || '';
    document.getElementById('books-filename').value = item.filename || '';
    document.getElementById('books-size').value = item.size || '';
    document.getElementById('books-date').value = item.date || '';
  } else if (type === 'files') {
    document.getElementById('files-id').value = item.id || '';
    document.getElementById('files-name').value = item.name || '';
    document.getElementById('files-type').value = item.type || '';
    document.getElementById('files-description').value = item.description || '';
    document.getElementById('files-filename').value = item.filename || '';
    document.getElementById('files-size').value = item.size || '';
    document.getElementById('files-date').value = item.date || '';
    document.getElementById('files-isFolder').checked = item.isFolder || false;
  } else if (type === 'writeups') {
    document.getElementById('writeups-id').value = item.id || '';
    document.getElementById('writeups-priority').value = item.priority || 5;
    document.getElementById('writeups-target').value = item.target || '';
    document.getElementById('writeups-title').value = item.title || '';
    document.getElementById('writeups-technique').value = item.technique || '';
    document.getElementById('writeups-date').value = item.date || '';
    document.getElementById('writeups-pubValue').value = item.pubValue || 'üî•üî•üî• MEDIUM';
    document.getElementById('writeups-tldr').value = item.tldr || '';
    document.getElementById('writeups-content').value = item.content || '';
    document.getElementById('writeups-images').value = (item.images || []).join(', ');
  }
}

// Add entry
function addEntry(type) {
  let newItem;
  if (type === 'breaks') {
    newItem = { id: 'new-' + Date.now(), name: 'New Break', technique: '', category: '', date: new Date().toISOString().split('T')[0] };
  } else if (type === 'books') {
    newItem = { id: 'new-' + Date.now(), title: 'New Book', author: 'elvec1o', date: new Date().toISOString().split('T')[0] };
  } else if (type === 'writeups') {
    newItem = { id: 'new-' + Date.now(), title: 'New Writeup', target: '', technique: '', priority: 5, pubValue: 'üî•üî•üî• MEDIUM', date: new Date().toISOString().split('T')[0] };
  } else {
    newItem = { id: 'new-' + Date.now(), name: 'New File', type: 'app', date: new Date().toISOString().split('T')[0] };
  }

  data[type].unshift(newItem);
  selectedIndex[type] = 0;
  renderList(type);
  showEditor(type, newItem);
}

// Update entry
function updateEntry(type) {
  const index = selectedIndex[type];
  if (index < 0) return;

  if (type === 'breaks') {
    const itemType = document.getElementById('breaks-type').value;
    if (itemType === 'xpost') {
      data.breaks[index] = {
        id: document.getElementById('breaks-id').value,
        type: 'xpost',
        tweetUrl: document.getElementById('breaks-tweetUrl').value,
        date: document.getElementById('breaks-date').value,
        note: document.getElementById('breaks-note').value
      };
    } else {
      data.breaks[index] = {
        id: document.getElementById('breaks-id').value,
        type: itemType || undefined,
        name: document.getElementById('breaks-name').value,
        technique: document.getElementById('breaks-technique').value,
        category: document.getElementById('breaks-category').value,
        date: document.getElementById('breaks-date').value,
        challenge: document.getElementById('breaks-challenge').value,
        insight: document.getElementById('breaks-insight').value,
        prompt: document.getElementById('breaks-prompt').value,
        result: document.getElementById('breaks-result').value,
        url: document.getElementById('breaks-url').value
      };
      // Clean undefined type
      if (!data.breaks[index].type) delete data.breaks[index].type;
    }
  } else if (type === 'books') {
    data.books[index] = {
      id: document.getElementById('books-id').value,
      title: document.getElementById('books-title').value,
      author: document.getElementById('books-author').value,
      description: document.getElementById('books-description').value,
      filename: document.getElementById('books-filename').value,
      size: document.getElementById('books-size').value,
      date: document.getElementById('books-date').value
    };
  } else if (type === 'files') {
    data.files[index] = {
      id: document.getElementById('files-id').value,
      name: document.getElementById('files-name').value,
      type: document.getElementById('files-type').value,
      description: document.getElementById('files-description').value,
      filename: document.getElementById('files-filename').value,
      size: document.getElementById('files-size').value,
      date: document.getElementById('files-date').value,
      isFolder: document.getElementById('files-isFolder').checked
    };
    if (!data.files[index].isFolder) delete data.files[index].isFolder;
  } else if (type === 'writeups') {
    const imagesStr = document.getElementById('writeups-images').value;
    data.writeups[index] = {
      id: document.getElementById('writeups-id').value,
      priority: parseInt(document.getElementById('writeups-priority').value) || 5,
      target: document.getElementById('writeups-target').value,
      title: document.getElementById('writeups-title').value,
      technique: document.getElementById('writeups-technique').value,
      date: document.getElementById('writeups-date').value,
      pubValue: document.getElementById('writeups-pubValue').value,
      tldr: document.getElementById('writeups-tldr').value,
      content: document.getElementById('writeups-content').value,
      images: imagesStr ? imagesStr.split(',').map(s => s.trim()).filter(Boolean) : []
    };
  }

  renderList(type);
  showToast('Entry updated (not saved yet)', 'success');
  logActivity('‚úèÔ∏è', 'Entry Updated', `${type}: ${data[type][index].name || data[type][index].title || data[type][index].id}`, 'info');
}

// Delete entry
function deleteEntry(type) {
  const index = selectedIndex[type];
  if (index < 0) return;
  if (!confirm('Delete this entry?')) return;

  const deletedName = data[type][index].name || data[type][index].title || data[type][index].id;
  data[type].splice(index, 1);
  selectedIndex[type] = -1;
  document.getElementById('editor-' + type).style.display = 'none';
  renderList(type);
  showToast('Entry deleted (not saved yet)', 'success');
  logActivity('üóëÔ∏è', 'Entry Deleted', `${type}: ${deletedName}`, 'warning');
}

// Cancel edit
function cancelEdit(type) {
  selectedIndex[type] = -1;
  document.getElementById('editor-' + type).style.display = 'none';
  renderList(type);
}

// Save data
async function saveData(type, push = false) {
  try {
    let payload, endpoint;
    if (type === 'config') {
      payload = {
        title: document.getElementById('config-title').value,
        tagline: document.getElementById('config-tagline').value,
        about1: document.getElementById('config-about1').value,
        about2: document.getElementById('config-about2').value,
        xHandle: document.getElementById('config-xHandle').value,
        grayswanUser: document.getElementById('config-grayswanUser').value
      };
      endpoint = '/api/config';
    } else {
      payload = data[type];
      endpoint = '/api/' + type;
    }

    const res = await fetch(API + endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: payload, push })
    });
    const result = await res.json();

    if (result.success === true) {
      showToast(result.message, 'success');
      checkGitStatus();
      if (push) {
        logActivity('üöÄ', 'Saved & Pushed', `${type} saved and pushed to GitHub`, 'success');
      } else {
        logActivity('üíæ', 'Saved Locally', `${type} saved to local files`, 'success');
      }
    } else {
      // Show error modal with fix suggestions
      const errorMsg = result.message || result.error || 'Unknown error';
      showErrorModal(errorMsg, { type: 'save', dataType: type, push });
      logActivity('‚ùå', 'Save Failed', `${type}: ${errorMsg.substring(0, 50)}...`, 'error');
    }
  } catch (err) {
    showErrorModal('Network error: ' + err.message, { type: 'save', dataType: type, push });
    logActivity('‚ùå', 'Network Error', err.message, 'error');
  }
}

// Push modal
function pushChanges() {
  document.getElementById('pushModal').classList.add('active');
}

function closePushModal() {
  document.getElementById('pushModal').classList.remove('active');
}

async function confirmPush() {
  const message = document.getElementById('commitMessage').value || 'Update via CMS';
  closePushModal();

  try {
    const res = await fetch(API + '/api/push', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    });
    const result = await res.json();

    if (result.success === true) {
      showToast(result.message, 'success');
      checkGitStatus();
      logActivity('üöÄ', 'Pushed to GitHub', `Commit: "${message}"`, 'success');
    } else {
      const errorMsg = result.message || 'Push failed';
      showErrorModal(errorMsg, { type: 'push' });
      logActivity('‚ùå', 'Push Failed', errorMsg.substring(0, 50) + '...', 'error');
    }
  } catch (err) {
    showErrorModal('Network error: ' + err.message, { type: 'push' });
    logActivity('‚ùå', 'Network Error', err.message, 'error');
  }
}

// Toast
function showToast(message, type = '') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast show ' + type;
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// ============ ACTIVITY LOG ============
let activityItems = JSON.parse(localStorage.getItem('cms-activity') || '[]');

function logActivity(icon, title, detail, type = 'info') {
  const now = new Date();
  const item = {
    icon,
    title,
    detail,
    type,
    time: now.toLocaleTimeString(),
    date: now.toLocaleDateString(),
    timestamp: now.getTime()
  };

  activityItems.unshift(item);
  // Keep last 100 items
  if (activityItems.length > 100) activityItems.pop();

  localStorage.setItem('cms-activity', JSON.stringify(activityItems));
  renderActivity();
}

function renderActivity() {
  const log = document.getElementById('activityLog');
  if (activityItems.length === 0) {
    log.innerHTML = '<div class="activity-empty">No activity yet. Start editing to see your history here.</div>';
    return;
  }

  log.innerHTML = activityItems.map(item => `
    <div class="activity-item ${item.type}">
      <div class="activity-icon">${item.icon}</div>
      <div class="activity-content">
        <div class="activity-title">${item.title}</div>
        <div class="activity-detail">${item.detail}</div>
      </div>
      <div class="activity-time">${item.date === new Date().toLocaleDateString() ? item.time : item.date + ' ' + item.time}</div>
    </div>
  `).join('');
}

function clearActivity() {
  if (!confirm('Clear all activity history?')) return;
  activityItems = [];
  localStorage.removeItem('cms-activity');
  renderActivity();
  logActivity('üóëÔ∏è', 'History Cleared', 'Activity log was cleared', 'info');
}

function copyActivity() {
  const text = activityItems.map(item =>
    `[${item.date} ${item.time}] ${item.icon} ${item.title}: ${item.detail}`
  ).join('\n');

  navigator.clipboard.writeText(text).then(() => {
    showToast('Activity log copied!', 'success');
  });
}

// ============ ERROR HANDLING WITH FIXES ============
let lastAction = null;
const ERROR_FIXES = {
  'index.lock': {
    title: 'Git Lock File Exists',
    description: 'Another git process left a lock file. Remove it to continue:',
    command: 'rm -f .git/index.lock',
    canRetry: true
  },
  'could not read Username': {
    title: 'GitHub Authentication Required',
    description: 'Switch to SSH authentication (requires SSH key setup on GitHub):',
    command: 'git remote set-url origin git@github.com:ElVec1o/home.git',
    canRetry: true
  },
  'Permission denied (publickey)': {
    title: 'SSH Key Not Found',
    description: 'Your SSH key is not set up with GitHub. Run this to generate one:',
    command: 'ssh-keygen -t ed25519 -C "your_email@example.com"',
    canRetry: false
  },
  'Authentication failed': {
    title: 'GitHub Authentication Failed',
    description: 'Set up GitHub CLI authentication:',
    command: 'gh auth login',
    canRetry: true
  },
  'Could not resolve host': {
    title: 'Network Error',
    description: 'Check your internet connection and try again.',
    command: null,
    canRetry: true
  },
  'rejected': {
    title: 'Push Rejected',
    description: 'Remote has changes. Pull first:',
    command: 'git pull --rebase origin main',
    canRetry: true
  },
  'non-fast-forward': {
    title: 'Push Rejected - Need to Pull First',
    description: 'Remote has new commits. Pull and merge first:',
    command: 'git pull --rebase origin main',
    canRetry: true
  }
};

function showErrorModal(message, context = {}) {
  const modal = document.getElementById('errorModal');
  const titleEl = document.getElementById('errorTitle');
  const messageEl = document.getElementById('errorMessage');
  const fixSection = document.getElementById('fixSection');
  const fixDesc = document.getElementById('fixDescription');
  const fixCmd = document.getElementById('fixCommand');
  const retryBtn = document.getElementById('retryBtn');
  const terminalBtn = document.getElementById('terminalBtn');

  // Find matching fix
  let fix = null;
  for (const [key, value] of Object.entries(ERROR_FIXES)) {
    if (message.includes(key)) {
      fix = value;
      break;
    }
  }

  if (fix) {
    titleEl.textContent = fix.title;
    messageEl.textContent = message;
    fixSection.style.display = 'block';
    fixDesc.textContent = fix.description;

    if (fix.command) {
      fixCmd.textContent = fix.command;
      fixCmd.parentElement.style.display = 'flex';
      document.getElementById('runFixBtn').style.display = 'inline-block';
    } else {
      fixCmd.parentElement.style.display = 'none';
      document.getElementById('runFixBtn').style.display = 'none';
    }

    retryBtn.style.display = fix.canRetry ? 'inline-block' : 'none';
  } else {
    titleEl.textContent = 'Error';
    messageEl.textContent = message;
    fixSection.style.display = 'none';
    retryBtn.style.display = 'inline-block';
    terminalBtn.style.display = 'none';
  }

  lastAction = context;
  modal.classList.add('active');
}

function closeErrorModal() {
  document.getElementById('errorModal').classList.remove('active');
}

function copyFixCommand() {
  const cmd = document.getElementById('fixCommand').textContent;
  navigator.clipboard.writeText(cmd).then(() => {
    showToast('Command copied!', 'success');
    logActivity('üìã', 'Fix Command Copied', cmd, 'info');
  });
}

async function runFixCommand() {
  const cmd = document.getElementById('fixCommand').textContent;
  const btn = document.getElementById('runFixBtn');

  btn.disabled = true;
  btn.textContent = '‚è≥ Running...';

  try {
    const res = await fetch(API + '/api/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ command: cmd })
    });
    const result = await res.json();

    if (result.success) {
      showToast('‚úÖ Fix executed successfully!', 'success');
      logActivity('‚úÖ', 'Fix Executed', cmd, 'success');
      btn.textContent = '‚úÖ Done!';
      // Auto-retry after successful fix
      setTimeout(() => retryLastAction(), 1000);
    } else {
      showToast('Fix failed: ' + result.message, 'error');
      logActivity('‚ùå', 'Fix Failed', result.message, 'error');
      btn.textContent = '‚ö° Run Fix';
      btn.disabled = false;
    }
  } catch (err) {
    showToast('Error: ' + err.message, 'error');
    btn.textContent = '‚ö° Run Fix';
    btn.disabled = false;
  }
}

async function retryLastAction() {
  closeErrorModal();
  logActivity('üîÑ', 'Retrying Action', lastAction ? lastAction.type : 'unknown', 'info');
  if (lastAction && lastAction.type === 'save') {
    await saveData(lastAction.dataType, lastAction.push);
  } else if (lastAction && lastAction.type === 'push') {
    await confirmPush();
  }
}

// ============ DEBUG PANEL ============
let debugLogs = [];

function debugLog(message, type = 'info', data = null) {
  const time = new Date().toLocaleTimeString();
  const entry = { time, message, type, data };
  debugLogs.push(entry);

  const logEl = document.getElementById('debugLog');
  const countEl = document.getElementById('debugCount');

  let dataStr = '';
  if (data) {
    try {
      dataStr = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    } catch (e) {
      dataStr = String(data);
    }
  }

  const entryHtml = `<div class="debug-entry ${type}">
    <span class="debug-time">[${time}]</span>
    <span>${message}</span>
    ${dataStr ? `<pre style="margin:0.2rem 0 0 1rem;font-size:11px;color:#aaa;white-space:pre-wrap;">${dataStr}</pre>` : ''}
  </div>`;

  logEl.innerHTML += entryHtml;
  logEl.scrollTop = logEl.scrollHeight;
  countEl.textContent = debugLogs.length;
}

function toggleDebugPanel() {
  const panel = document.getElementById('debugPanel');
  const btn = panel.querySelector('.debug-controls button:last-child');
  panel.classList.toggle('expanded');
  btn.textContent = panel.classList.contains('expanded') ? '‚ñº Collapse' : '‚ñ≤ Expand';
}

function clearDebugLog() {
  debugLogs = [];
  document.getElementById('debugLog').innerHTML = '';
  document.getElementById('debugCount').textContent = '0';
  debugLog('Log cleared', 'info');
}

function copyDebugLog() {
  const text = debugLogs.map(e => {
    let line = `[${e.time}] [${e.type.toUpperCase()}] ${e.message}`;
    if (e.data) {
      try {
        line += '\n  ' + (typeof e.data === 'string' ? e.data : JSON.stringify(e.data));
      } catch (err) {
        line += '\n  ' + String(e.data);
      }
    }
    return line;
  }).join('\n');

  navigator.clipboard.writeText(text).then(() => {
    showToast('Debug log copied!', 'success');
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('Debug log copied!', 'success');
  });
}

// Override fetch to log all API calls
const originalFetch = window.fetch;
window.fetch = async function(...args) {
  const url = args[0];
  const options = args[1] || {};

  debugLog(`‚Üí ${options.method || 'GET'} ${url}`, 'info');

  try {
    const response = await originalFetch.apply(this, args);
    const clone = response.clone();

    try {
      const data = await clone.json();
      if (response.ok) {
        debugLog(`‚Üê ${response.status} ${url}`, 'success', data);
      } else {
        debugLog(`‚Üê ${response.status} ${url} FAILED`, 'error', data);
      }
    } catch (e) {
      debugLog(`‚Üê ${response.status} ${url} (non-JSON response)`, response.ok ? 'success' : 'error');
    }

    return response;
  } catch (err) {
    debugLog(`‚úó ${url} - ${err.message}`, 'error');
    throw err;
  }
};

// ============ SETTINGS / AUTH ============
async function loadSettings() {
  try {
    const res = await fetch(API + '/api/git-remote');
    const data = await res.json();
    document.getElementById('currentRemote').textContent = data.remote || 'Not configured';
  } catch (err) {
    document.getElementById('currentRemote').textContent = 'Error loading';
  }
}

async function generateSSHKey() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Generating...';

  try {
    const res = await fetch(API + '/api/ssh/generate', { method: 'POST' });
    const data = await res.json();

    if (data.success) {
      document.getElementById('sshPublicKey').value = data.publicKey;
      document.getElementById('sshKeyDisplay').style.display = 'block';
      showToast('SSH key generated!', 'success');
      logActivity('üîë', 'SSH Key Generated', 'New SSH key pair created', 'success');
    } else {
      showToast('Error: ' + data.message, 'error');
    }
  } catch (err) {
    showToast('Error: ' + err.message, 'error');
  }

  btn.disabled = false;
  btn.textContent = 'üîë Generate SSH Key';
}

async function checkSSHKey() {
  try {
    const res = await fetch(API + '/api/ssh/check');
    const data = await res.json();

    if (data.exists) {
      document.getElementById('sshPublicKey').value = data.publicKey;
      document.getElementById('sshKeyDisplay').style.display = 'block';
      showToast('SSH key found!', 'success');
    } else {
      showToast('No SSH key found. Generate one first.', 'error');
    }
  } catch (err) {
    showToast('Error: ' + err.message, 'error');
  }
}

function copySSHKey() {
  const key = document.getElementById('sshPublicKey').value;
  navigator.clipboard.writeText(key).then(() => {
    showToast('SSH key copied!', 'success');
  });
}

async function testSSHConnection() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Testing...';

  try {
    const res = await fetch(API + '/api/ssh/test');
    const data = await res.json();

    if (data.success) {
      showToast('‚úÖ SSH connection works!', 'success');
      logActivity('‚úÖ', 'SSH Test Passed', 'Connection to GitHub successful', 'success');
    } else {
      showToast('‚ùå ' + data.message, 'error');
      logActivity('‚ùå', 'SSH Test Failed', data.message, 'error');
    }
  } catch (err) {
    showToast('Error: ' + err.message, 'error');
  }

  btn.disabled = false;
  btn.textContent = 'üß™ Test SSH Connection';
}

async function switchToSSH() {
  try {
    const res = await fetch(API + '/api/use-ssh', { method: 'POST' });
    const data = await res.json();

    if (data.success) {
      showToast('‚úÖ Switched to SSH!', 'success');
      logActivity('‚úÖ', 'Switched to SSH', 'Remote URL updated to use SSH', 'success');
      loadSettings();
    } else {
      showToast('Error: ' + data.message, 'error');
    }
  } catch (err) {
    showToast('Error: ' + err.message, 'error');
  }
}

async function saveGitHubToken() {
  const token = document.getElementById('ghToken').value.trim();
  if (!token) {
    showToast('Please enter a token', 'error');
    return;
  }

  try {
    const res = await fetch(API + '/api/auth/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token })
    });
    const data = await res.json();

    if (data.success) {
      showToast('‚úÖ Token configured!', 'success');
      logActivity('‚úÖ', 'GitHub Token Set', 'HTTPS authentication configured', 'success');
      document.getElementById('ghToken').value = '';
      loadSettings();
    } else {
      showToast('Error: ' + data.message, 'error');
    }
  } catch (err) {
    showToast('Error: ' + err.message, 'error');
  }
}

// ============ FILE UPLOADS ============
let currentFolder = 'img';
let selectedFile = null;

async function loadFilesList(folder = null) {
  if (folder) currentFolder = folder;
  document.getElementById('currentFolder').textContent = '/' + currentFolder;

  try {
    const res = await fetch(API + `/api/files-list/${currentFolder}`);
    const data = await res.json();

    const list = document.getElementById('filesList');
    if (!data.files || data.files.length === 0) {
      list.innerHTML = '<div class="activity-empty">No files in this folder</div>';
      return;
    }

    list.innerHTML = data.files.map(f => `
      <div class="file-item ${f.isDirectory ? 'folder' : ''}" onclick="selectFile('${f.path}', ${f.isDirectory}, '${f.name}')" ondblclick="${f.isDirectory ? `loadFilesList('${currentFolder}/${f.name}')` : ''}">
        <span class="file-icon">${f.isDirectory ? 'üìÅ' : getFileIcon(f.name)}</span>
        <span class="file-name">${f.name}</span>
        <span class="file-size">${f.isDirectory ? '' : formatSize(f.size)}</span>
      </div>
    `).join('');
  } catch (err) {
    showToast('Error loading files: ' + err.message, 'error');
  }
}

function getFileIcon(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const icons = {
    'png': 'üñºÔ∏è', 'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'gif': 'üñºÔ∏è', 'webp': 'üñºÔ∏è', 'svg': 'üñºÔ∏è',
    'pdf': 'üìÑ', 'doc': 'üìù', 'docx': 'üìù', 'txt': 'üìù',
    'zip': 'üì¶', 'rar': 'üì¶', '7z': 'üì¶',
    'mp4': 'üé¨', 'mov': 'üé¨', 'avi': 'üé¨',
    'mp3': 'üéµ', 'wav': 'üéµ'
  };
  return icons[ext] || 'üìÑ';
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function selectFile(filepath, isDir, name) {
  selectedFile = { path: filepath, isDir, name };

  document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
  event.currentTarget.classList.add('selected');

  const preview = document.getElementById('filePreview');
  const content = document.getElementById('previewContent');

  if (isDir) {
    preview.style.display = 'none';
    return;
  }

  preview.style.display = 'block';
  const ext = name.split('.').pop().toLowerCase();

  if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'].includes(ext)) {
    content.innerHTML = `
      <img src="http://localhost:3333${filepath}" style="max-width:100%;max-height:200px;border:1px solid #ddd;">
      <p style="margin-top:0.5rem;font-family:monospace;font-size:0.85rem;">${filepath}</p>
    `;
  } else {
    content.innerHTML = `<p style="font-family:monospace;">${filepath}</p>`;
  }
}

function navigateUp() {
  if (currentFolder === 'img' || currentFolder === '') return;
  const parts = currentFolder.split('/');
  parts.pop();
  loadFilesList(parts.join('/') || 'img');
}

function copyFilePath() {
  if (!selectedFile) return;
  navigator.clipboard.writeText(selectedFile.path).then(() => {
    showToast('Path copied: ' + selectedFile.path, 'success');
  });
}

async function deleteSelectedFile() {
  if (!selectedFile || selectedFile.isDir) return;
  if (!confirm(`Delete ${selectedFile.name}?`)) return;

  try {
    const res = await fetch(API + '/api/files-delete', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filepath: selectedFile.path })
    });
    const data = await res.json();

    if (data.success) {
      showToast('File deleted', 'success');
      logActivity('üóëÔ∏è', 'File Deleted', selectedFile.path, 'warning');
      loadFilesList();
      document.getElementById('filePreview').style.display = 'none';
      selectedFile = null;
    } else {
      showToast('Error: ' + data.message, 'error');
    }
  } catch (err) {
    showToast('Error: ' + err.message, 'error');
  }
}

async function uploadFiles(files) {
  if (!files || files.length === 0) return;

  const folder = document.getElementById('uploadFolder').value;
  const formData = new FormData();

  for (const file of files) {
    formData.append('files', file);
  }
  formData.append('folder', folder);

  try {
    showToast(`Uploading ${files.length} file(s)...`, 'info');

    const res = await fetch(API + '/api/upload', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();

    if (data.success) {
      showToast(`‚úÖ ${data.files.length} file(s) uploaded!`, 'success');
      logActivity('üì§', 'Files Uploaded', data.files.map(f => f.filename).join(', '), 'success');
      loadFilesList(folder);
    } else {
      showToast('Error: ' + data.message, 'error');
    }
  } catch (err) {
    showToast('Upload error: ' + err.message, 'error');
  }

  document.getElementById('fileInput').value = '';
}

async function createFolder() {
  const name = prompt('Folder name:');
  if (!name) return;

  const folderPath = currentFolder + '/' + name;

  try {
    const res = await fetch(API + '/api/folders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ folderPath })
    });
    const data = await res.json();

    if (data.success) {
      showToast('Folder created', 'success');
      logActivity('üìÅ', 'Folder Created', folderPath, 'success');
      loadFilesList();
    } else {
      showToast('Error: ' + data.message, 'error');
    }
  } catch (err) {
    showToast('Error: ' + err.message, 'error');
  }
}

async function pushUploads() {
  try {
    const res = await fetch(API + '/api/push', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: 'Upload files via CMS' })
    });
    const data = await res.json();

    if (data.success) {
      showToast('‚úÖ Uploads pushed to GitHub!', 'success');
      logActivity('üöÄ', 'Uploads Pushed', 'Files pushed to GitHub', 'success');
      checkGitStatus();
    } else {
      showErrorModal(data.message, { type: 'push' });
    }
  } catch (err) {
    showToast('Error: ' + err.message, 'error');
  }
}

// ============ WRITEUPS ============
// Writeups are stored in data.writeups, loaded/saved like other content

// ============ IMPORT FUNCTIONALITY ============
let parsedImportItems = [];

function parseImport() {
  const xml = document.getElementById('import-xml').value.trim();
  const importType = document.getElementById('import-type').value;

  if (!xml) {
    showToast('Please paste some XML content first', 'error');
    return;
  }

  try {
    // Parse XML
    const parser = new DOMParser();
    const doc = parser.parseFromString(xml, 'text/xml');

    // Check for parse errors
    const parseError = doc.querySelector('parsererror');
    if (parseError) {
      showToast('XML Parse Error: ' + parseError.textContent.substring(0, 100), 'error');
      return;
    }

    // Find all article/writeup/item elements
    const itemTags = ['article', 'writeup', 'item', 'break', 'entry'];
    let items = [];

    for (const tag of itemTags) {
      const found = doc.querySelectorAll(tag);
      if (found.length > 0) {
        items = Array.from(found);
        break;
      }
    }

    if (items.length === 0) {
      showToast('No items found. Use <article>, <writeup>, <item>, or <break> tags.', 'error');
      return;
    }

    // Parse each item
    parsedImportItems = items.map((item, index) => {
      const getField = (names) => {
        for (const name of names) {
          const el = item.querySelector(name);
          if (el) return el.textContent.trim();
        }
        return '';
      };

      // Determine type automatically or use selected
      let type = importType;
      if (type === 'auto') {
        type = item.tagName.toLowerCase() === 'break' ? 'breaks' : 'writeups';
      }

      if (type === 'writeups') {
        return {
          _type: 'writeups',
          id: getField(['id', 'slug']) || 'writeup-' + (Date.now() + index),
          priority: parseInt(getField(['priority', 'order'])) || (index + 1),
          target: getField(['target', 'model', 'system']),
          title: getField(['title', 'name', 'heading']),
          technique: getField(['technique', 'method', 'category']),
          date: getField(['date', 'published']) || new Date().toISOString().split('T')[0],
          pubValue: getField(['pubValue', 'pubvalue', 'severity', 'value']) || 'üî•üî•üî• MEDIUM',
          tldr: getField(['tldr', 'summary', 'excerpt', 'description']),
          content: getField(['content', 'body', 'text', 'article']),
          images: (getField(['images', 'screenshots']) || '').split(',').map(s => s.trim()).filter(Boolean)
        };
      } else {
        return {
          _type: 'breaks',
          id: getField(['id', 'slug']) || 'break-' + (Date.now() + index),
          name: getField(['name', 'title']),
          technique: getField(['technique', 'method']),
          category: getField(['category', 'type']),
          date: getField(['date']) || new Date().toISOString().split('T')[0],
          challenge: getField(['challenge', 'goal']),
          insight: getField(['insight', 'explanation']),
          prompt: getField(['prompt', 'attack']),
          result: getField(['result', 'outcome']),
          url: getField(['url', 'link'])
        };
      }
    });

    // Show preview
    renderImportPreview();

  } catch (err) {
    showToast('Error parsing: ' + err.message, 'error');
    debugLog('Import parse error', 'error', err.message);
  }
}

function renderImportPreview() {
  const preview = document.getElementById('import-preview');
  const itemsEl = document.getElementById('import-items');
  const countEl = document.getElementById('import-count');

  preview.style.display = 'block';
  countEl.textContent = parsedImportItems.length;

  itemsEl.innerHTML = parsedImportItems.map((item, i) => `
    <div class="entry-item" style="cursor:default;">
      <div class="entry-item-info">
        <div class="entry-item-title">
          ${item.title || item.name || item.id}
          <span class="entry-item-type">${item._type}</span>
          <span class="entry-item-type">#${i + 1}</span>
        </div>
        <div class="entry-item-meta">
          ${item.target || item.category || ''} ¬∑ ${item.technique || ''} ¬∑ ${item.date}
        </div>
      </div>
      <button class="secondary" style="padding:0.2rem 0.5rem;font-size:0.75rem;" onclick="removeImportItem(${i})">‚úï</button>
    </div>
  `).join('');

  logActivity('üîç', 'Import Parsed', `${parsedImportItems.length} items detected`, 'info');
}

function removeImportItem(index) {
  parsedImportItems.splice(index, 1);
  if (parsedImportItems.length === 0) {
    document.getElementById('import-preview').style.display = 'none';
  } else {
    renderImportPreview();
  }
}

async function executeImport(push = false) {
  if (parsedImportItems.length === 0) {
    showToast('No items to import', 'error');
    return;
  }

  const replace = document.getElementById('import-replace').checked;
  const resultEl = document.getElementById('import-result');

  // Group items by type
  const grouped = { writeups: [], breaks: [] };
  parsedImportItems.forEach(item => {
    const type = item._type;
    delete item._type; // Remove internal marker
    grouped[type].push(item);
  });

  let imported = { writeups: 0, breaks: 0 };
  let errors = [];

  for (const [type, items] of Object.entries(grouped)) {
    if (items.length === 0) continue;

    try {
      // If replace, use items directly; otherwise append to existing
      let finalData;
      if (replace) {
        finalData = items;
      } else {
        // Load existing and append
        const existing = data[type] || [];
        finalData = [...existing, ...items];
      }

      // Save
      const res = await fetch(API + '/api/' + type, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: finalData, push: false })
      });
      const result = await res.json();

      if (result.success) {
        data[type] = finalData;
        imported[type] = items.length;
        renderList(type);
      } else {
        errors.push(`${type}: ${result.message || result.error}`);
      }
    } catch (err) {
      errors.push(`${type}: ${err.message}`);
    }
  }

  // Show result
  const total = imported.writeups + imported.breaks;
  if (errors.length === 0) {
    resultEl.style.display = 'block';
    resultEl.style.background = '#e8f5e9';
    resultEl.innerHTML = `<strong>‚úÖ Success!</strong> Imported ${total} items (${imported.writeups} writeups, ${imported.breaks} breaks)`;
    logActivity('‚úÖ', 'Import Complete', `${total} items imported`, 'success');

    // Push if requested
    if (push) {
      const pushRes = await fetch(API + '/api/push', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: `Import ${total} items via CMS` })
      });
      const pushResult = await pushRes.json();

      if (pushResult.success) {
        resultEl.innerHTML += '<br><strong>üöÄ Pushed to GitHub!</strong>';
        logActivity('üöÄ', 'Import Pushed', 'Changes pushed to GitHub', 'success');
      } else {
        resultEl.innerHTML += `<br><strong>‚ö†Ô∏è Push failed:</strong> ${pushResult.message}`;
      }
    }

    // Clear form
    document.getElementById('import-xml').value = '';
    document.getElementById('import-preview').style.display = 'none';
    parsedImportItems = [];
    checkGitStatus();
  } else {
    resultEl.style.display = 'block';
    resultEl.style.background = '#ffebee';
    resultEl.innerHTML = `<strong>‚ö†Ô∏è Partial import:</strong> ${total} imported, errors: ${errors.join('; ')}`;
    logActivity('‚ö†Ô∏è', 'Import Partial', errors.join('; '), 'warning');
  }
}

function clearImport() {
  document.getElementById('import-xml').value = '';
  document.getElementById('import-preview').style.display = 'none';
  document.getElementById('import-result').style.display = 'none';
  parsedImportItems = [];
}

function loadSampleXML() {
  const sample = `<articles>
  <article>
    <id>sample-writeup-1</id>
    <priority>1</priority>
    <target>Claude (Anthropic)</target>
    <title>Sample Writeup Title</title>
    <technique>Prompt Injection</technique>
    <date>2025-01-15</date>
    <pubValue>üî•üî•üî•üî• HIGH</pubValue>
    <tldr>This is a sample TL;DR describing the key finding.</tldr>
    <content>## Background

This is the full writeup content in markdown.

## The Attack

Detailed explanation of the vulnerability.

## Impact

What this means for security.

## Status

Reported and acknowledged.</content>
    <images>/img/writeups/sample1.png</images>
  </article>

  <article>
    <id>sample-writeup-2</id>
    <priority>2</priority>
    <target>GPT-4</target>
    <title>Another Sample Finding</title>
    <technique>Memory Manipulation</technique>
    <date>2025-01-10</date>
    <pubValue>üî•üî•üî• MEDIUM</pubValue>
    <tldr>Brief summary of the second finding.</tldr>
    <content>## Overview

Content for the second writeup...</content>
  </article>
</articles>`;

  document.getElementById('import-xml').value = sample;
  showToast('Sample XML loaded. Click "Parse & Preview" to test.', 'success');
}

// Init
debugLog('CMS initialized', 'info');
renderActivity();
logActivity('üü¢', 'CMS Started', 'Session initialized', 'info');
loadAll();
loadSettings();
loadFilesList();
</script>
</body>
</html>
