---
import Base from '../layouts/Base.astro';
import breaksData from '../data/breaks.json';

const breaks = breaksData.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
const base = import.meta.env.BASE_URL;

// Count by type
const writeups = breaks.filter(b => b.type === 'writeup' || b.tldr);
const posts = breaks.filter(b => b.type === 'post');
const xposts = breaks.filter(b => b.type === 'xpost');
const legacy = breaks.filter(b => !b.type && !b.tldr);

// Get last 5 X posts for featured section
const featuredXposts = xposts.slice(0, 5);

// Convert [[SPOILER]]text[[/SPOILER]] to HTML blur spans
function renderSpoiler(text: string): string {
  if (!text) return '';
  return text.replace(
    /\[\[SPOILER\]\]([\s\S]*?)\[\[\/SPOILER\]\]/g,
    '<span class="spoiler"><span class="spoiler-content">$1</span><span class="spoiler-label">hover to reveal</span></span>'
  );
}

// Convert [[LOCKED:hash]]text[[/LOCKED]] to password-protected content
function renderLocked(text: string, id: string): string {
  if (!text) return '';
  let counter = 0;
  return text.replace(
    /\[\[LOCKED:([a-f0-9]+)\]\]([\s\S]*?)\[\[\/LOCKED\]\]/g,
    (match, hash, content) => {
      const lockId = `${id}-lock-${counter++}`;
      const isShort = content.length < 200 && !content.includes('\n');
      if (isShort) {
        return `<span class="locked-inline" id="${lockId}" data-hash="${hash}"><span class="locked-inline-trigger" onclick="promptUnlock('${lockId}')">üîê [locked]</span><span class="locked-inline-content">${content}</span></span>`;
      } else {
        return `<div class="locked" id="${lockId}" data-hash="${hash}">
          <div class="locked-overlay">
            <span class="locked-icon">üîê</span>
            <span class="locked-text">Password Protected</span>
            <div class="locked-input">
              <input type="password" placeholder="Password" onkeypress="if(event.key==='Enter')unlockContent('${lockId}')">
              <button onclick="unlockContent('${lockId}')">Unlock</button>
            </div>
            <div class="locked-error"></div>
          </div>
          <div class="locked-content">${content}</div>
        </div>`;
      }
    }
  );
}

function renderProtected(text: string, id: string): string {
  if (!text) return '';
  let result = renderSpoiler(text);
  result = renderLocked(result, id);
  return result;
}
---
<Base title="Posts ‚Äî elvec1o">
  <h1>Posts</h1>
  <p>{breaks.length} entries</p>

  <!-- Featured X Posts Section -->
  <div id="featured-tweets" class="featured-section">
    <h2>Latest from X</h2>
    <div class="tweet-grid">
      {featuredXposts.map(xp => (
        <div class="tweet-card">
          <blockquote class="twitter-tweet" data-conversation="none" data-dnt="true">
            <a href={xp.tweetUrl}></a>
          </blockquote>
          {xp.note && <p class="tweet-note">{xp.note}</p>}
        </div>
      ))}
    </div>
    <p class="featured-link"><a href="https://x.com/elvec10" target="_blank">‚Üí Follow @elvec10 on X</a></p>
  </div>

  <div class="tabs">
    <button class="tab" data-filter="all">All</button>
    <button class="tab" data-filter="writeup">Writeups</button>
    <button class="tab" data-filter="post">Posts</button>
    <button class="tab" data-filter="xpost">X</button>
  </div>

  {breaks.map((brk, i) => {
    const entryType = brk.type || (brk.tldr ? 'writeup' : 'legacy');
    return (
      <div class={`break-entry entry-${entryType}`} data-type={entryType}>

        {/* X POST TYPE */}
        {entryType === 'xpost' && (
          <>
            <p class="meta">{brk.date}</p>
            <div class="xpost-embed" set:html={brk.embedHtml || `<blockquote class="twitter-tweet"><a href="${brk.tweetUrl}"></a></blockquote>`} />
            {brk.note && <p class="xpost-note">{brk.note}</p>}
          </>
        )}

        {/* SHORT POST TYPE */}
        {entryType === 'post' && (
          <>
            <h3>{brk.name}</h3>
            <p class="meta">{brk.category} ¬∑ {brk.date}</p>
            {brk.images && brk.images.map((img: string) => (
              <div class="screenshot">
                <img src={`${base}/img/${img}`} alt={brk.name} />
              </div>
            ))}
            <p>{brk.content}</p>
            {brk.url && <p><a href={brk.url} target="_blank">‚Üí Link</a></p>}
          </>
        )}

        {/* WRITEUP TYPE (new format) */}
        {entryType === 'writeup' && (
          <>
            <h3>#{i + 1} ‚Äî {brk.name}</h3>
            <p class="meta">{brk.category} ¬∑ {brk.technique} ¬∑ {brk.date}</p>

            {brk.tldr && (
              <div class="tldr">
                <strong>TL;DR:</strong> {brk.tldr}
              </div>
            )}

            {brk.images && brk.images.map((img: string, idx: number) => (
              <div class="screenshot">
                <img src={`${base}/img/${img}`} alt={`${brk.name} screenshot ${idx + 1}`} />
              </div>
            ))}

            {brk.summary && (
              <>
                <h4>High Level Summary</h4>
                <p>{brk.summary}</p>
              </>
            )}

            {brk.userPrompt && (
              <div class="quote-user" set:html={renderProtected(brk.userPrompt, brk.id + '-user')} />
            )}

            {brk.modelResponse && (
              <div class="quote-model" set:html={renderProtected(brk.modelResponse, brk.id + '-model')} />
            )}

            {brk.modelThinking && (
              <div class="quote-thinking">{brk.modelThinking}</div>
            )}

            {brk.considerations && (
              <div class="considerations">
                <strong>Considerations:</strong> {brk.considerations}
              </div>
            )}

            {brk.url && <p><a href={brk.url} target="_blank">‚Üí View on Gray Swan</a></p>}
          </>
        )}

        {/* LEGACY TYPE (old format) */}
        {entryType === 'legacy' && (
          <>
            <h3>#{i + 1} ‚Äî {brk.name}</h3>
            <p class="meta">{brk.category} ¬∑ {brk.technique} ¬∑ {brk.date}</p>
            <p><strong>Challenge:</strong> {brk.challenge}</p>
            <div class="insight">{brk.insight}</div>
            <p><strong>Prompt:</strong></p>
            <pre>{brk.prompt}</pre>
            <p><strong>Result:</strong> {brk.result}</p>
            {brk.url && <p><a href={brk.url} target="_blank">‚Üí View on Gray Swan</a></p>}
          </>
        )}

      </div>
    );
  })}

  <p><a href={`${base}/`}>‚Üê Back home</a></p>
</Base>

<style>
  /* Featured tweets section */
  .featured-section {
    background: #f9f9f9;
    border: 1px solid #ddd;
    padding: 1.5rem;
    margin: 1.5rem 0;
  }
  .featured-section h2 {
    margin: 0 0 1rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    border: none;
  }
  .tweet-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
  }
  .tweet-card {
    background: #fff;
    border: 1px solid #e1e8ed;
    padding: 0.5rem;
    min-height: 150px;
  }
  .tweet-card blockquote {
    margin: 0 !important;
  }
  .tweet-note {
    font-size: 0.8rem;
    color: #666;
    font-style: italic;
    margin: 0.5rem 0 0;
    padding-top: 0.5rem;
    border-top: 1px solid #eee;
  }
  .featured-link {
    margin: 1rem 0 0;
    text-align: right;
    font-size: 0.85rem;
  }

  .tabs {
    margin: 2rem 0;
    display: flex;
    gap: 0.5rem;
    border-bottom: 1px solid #ddd;
    padding-bottom: 0.5rem;
  }
  .tab {
    background: #fff;
    border: 1px solid #ddd;
    padding: 0.4rem 0.8rem;
    font-family: inherit;
    font-size: 0.85rem;
    cursor: pointer;
    color: #111;
  }
  .tab:hover { background: #f5f5f5; }
  .tab.active { background: #111; color: #fff; border-color: #111; }

  .xpost-embed {
    margin: 1rem 0;
  }
  .xpost-note {
    font-style: italic;
    color: #666;
  }

  .entry-xpost {
    padding: 1rem 0;
    border-bottom: 1px solid #eee;
  }

  .entry-post {
    padding: 1.5rem 0;
  }

  .hidden { display: none; }
</style>

<script>
  // Twitter embed script
  const script = document.createElement('script');
  script.src = 'https://platform.twitter.com/widgets.js';
  script.async = true;
  document.body.appendChild(script);

  // Simple hash function for password verification
  function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return Math.abs(hash).toString(16);
  }

  // Unlock password-protected content (block version)
  function unlockContent(lockId) {
    const container = document.getElementById(lockId);
    const input = container.querySelector('input');
    const errorDiv = container.querySelector('.locked-error');
    const password = input.value;
    const expectedHash = container.dataset.hash;

    if (simpleHash(password) === expectedHash) {
      container.classList.add('unlocked');
      errorDiv.textContent = '';
    } else {
      errorDiv.textContent = 'Wrong password';
      input.value = '';
    }
  }

  // Prompt-based unlock for inline locked content
  function promptUnlock(lockId) {
    const container = document.getElementById(lockId);
    const expectedHash = container.dataset.hash;
    const password = prompt('Enter password to unlock:');

    if (password && simpleHash(password) === expectedHash) {
      container.classList.add('unlocked');
    } else if (password) {
      alert('Wrong password');
    }
  }

  // Make functions available globally
  window.unlockContent = unlockContent;
  window.promptUnlock = promptUnlock;

  // Tab filtering with localStorage persistence
  const STORAGE_KEY = 'elvec1o_posts_tab';

  function applyFilter(filter) {
    // Update tabs
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    const activeTab = document.querySelector(`.tab[data-filter="${filter}"]`);
    if (activeTab) activeTab.classList.add('active');

    // Show/hide featured section (only on 'all' or 'xpost')
    const featured = document.getElementById('featured-tweets');
    if (featured) {
      featured.style.display = (filter === 'all' || filter === 'xpost') ? 'block' : 'none';
    }

    // Filter entries
    document.querySelectorAll('.break-entry').forEach(entry => {
      if (filter === 'all') {
        entry.classList.remove('hidden');
      } else {
        const type = entry.dataset.type;
        if (filter === 'writeup' && (type === 'writeup' || type === 'legacy')) {
          entry.classList.remove('hidden');
        } else if (type === filter) {
          entry.classList.remove('hidden');
        } else {
          entry.classList.add('hidden');
        }
      }
    });

    // Save to localStorage
    try {
      localStorage.setItem(STORAGE_KEY, filter);
    } catch (e) {}
  }

  // Initialize from localStorage or default to 'all'
  function initTabs() {
    let savedFilter = 'all';
    try {
      savedFilter = localStorage.getItem(STORAGE_KEY) || 'all';
    } catch (e) {}
    applyFilter(savedFilter);
  }

  // Tab click handlers
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const filter = tab.dataset.filter;
      applyFilter(filter);
    });
  });

  // Initialize on load
  initTabs();
</script>
